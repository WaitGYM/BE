generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id    Int    @id @default(autoincrement())
  email String @unique
  name  String

  // OAuth ì „ìš© í•„ë“œ
  googleId String  @unique
  avatar   String?

  createdAt    DateTime      @default(now())
  reservations Reservation[]
  favorites    Favorite[]
  
  // ì›¨ì´íŒ… ì‹œìŠ¤í…œ ê´€ê³„ ì¶”ê°€
  equipmentUsages EquipmentUsage[]
  waitingQueues   WaitingQueue[]
}

model Equipment {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  imageUrl     String?
  category     String        // ë¶€ìœ„ë³„ ì¹´í…Œê³ ë¦¬ (ê°€ìŠ´, ë“±, ë‹¤ë¦¬, ì–´ê¹¨, íŒ”, ìœ ì‚°ì†Œ ë“±)
  muscleGroup  String?       // ì„¸ë¶€ ê·¼ìœ¡ ê·¸ë£¹ (ì„ íƒì‚¬í•­)
  createdAt    DateTime      @default(now())
  reservations Reservation[]
  favorites    Favorite[]
  
  // ì›¨ì´íŒ… ì‹œìŠ¤í…œ ê´€ê³„ ì¶”ê°€
  equipmentUsages EquipmentUsage[]
  waitingQueues   WaitingQueue[]
}

model Favorite {
  id          Int       @id @default(autoincrement())
  userId      Int
  equipmentId Int
  createdAt   DateTime  @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([userId, equipmentId]) // ì¤‘ë³µ ì¦ê²¨ì°¾ê¸° ë°©ì§€
}

// ê¸°ì¡´ ì˜ˆì•½ ì‹œìŠ¤í…œ (ì‹œê°„ ê¸°ë°˜) - í˜¸í™˜ì„± ìœ ì§€
model Reservation {
  id          Int      @id @default(autoincrement())
  userId      Int
  equipmentId Int
  startAt     DateTime
  endAt       DateTime
  sets        Int      @default(1)
  restMinutes Int      @default(3)
  status      String   @default("BOOKED")

  user      User      @relation(fields: [userId], references: [id])
  equipment Equipment @relation(fields: [equipmentId], references: [id])

  @@index([equipmentId, startAt, endAt])
}

// ğŸ”¥ ì›¨ì´íŒ… ì‹œìŠ¤í…œ: í˜„ì¬ ê¸°êµ¬ ì‚¬ìš© ìƒíƒœ
model EquipmentUsage {
  id              Int       @id @default(autoincrement())
  equipmentId     Int
  userId          Int
  startedAt       DateTime  @default(now())
  endedAt         DateTime? // ì‚¬ìš© ì™„ë£Œ ì‹œê°„
  estimatedEndAt  DateTime? // ì˜ˆìƒ ì¢…ë£Œ ì‹œê°„ (ì„ íƒì‚¬í•­)
  // ì´ ì„¸íŠ¸ & íœ´ì‹
  totalSets          Int       @default(1)    // ì´ ì„¸íŠ¸ ìˆ˜
  restMinutes        Int       @default(3)    // ì„¸íŠ¸ ì‚¬ì´ íœ´ì‹(ë¶„)

  // ì„¸ì…˜ ìƒíƒœ
  status             String    @default("IN_USE") // IN_USE | COMPLETED

  // ğŸ”¥ ì„¸íŠ¸/íœ´ì‹ ì •ë°€ ì¶”ì 
  currentSet          Int       @default(1)
  setStatus           String    @default("EXERCISING") // EXERCISING | RESTING | COMPLETED | STOPPED | FORCE_COMPLETED
  currentSetStartedAt DateTime?
  restStartedAt       DateTime?

  createdAt          DateTime  @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Restrict)
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Restrict)

  @@index([equipmentId, status])
}

// ğŸ”¥ ì›¨ì´íŒ… ì‹œìŠ¤í…œ: ëŒ€ê¸°ì—´ ê´€ë¦¬  
model WaitingQueue {
  id            Int       @id @default(autoincrement())
  equipmentId   Int
  userId        Int
  queuePosition Int       // ëŒ€ê¸° ìˆœì„œ (1, 2, 3, ...)
  status        String    @default("WAITING") // WAITING, NOTIFIED, COMPLETED, CANCELLED, EXPIRED
  createdAt     DateTime  @default(now())
  notifiedAt    DateTime? // ì•Œë¦¼ ë°œì†¡ ì‹œê°„
  updatedAt     DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([equipmentId, queuePosition])
  @@index([equipmentId, status])
  @@unique([equipmentId, userId, status], name: "unique_active_queue") // ê°™ì€ ê¸°êµ¬ì— ì¤‘ë³µ ëŒ€ê¸° ë°©ì§€
}